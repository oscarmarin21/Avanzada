<h1 class="text-2xl font-semibold text-gray-900 mb-4">Requests</h1>

@if (error()) {
  <p class="text-red-600 mb-2">{{ error() }}</p>
}

<div class="flex flex-wrap gap-4 items-end mb-4">
  <label class="flex flex-col gap-1">
    <span class="text-sm font-medium text-gray-700">State</span>
    <select [ngModel]="filterState()" (ngModelChange)="filterState.set($event)" class="min-w-[140px] rounded border border-gray-300 px-3 py-2 text-sm">
      <option value="">All</option>
      @for (s of states(); track s.id) {
        <option [value]="s.code">{{ s.name }}</option>
      }
    </select>
  </label>
  <label class="flex flex-col gap-1">
    <span class="text-sm font-medium text-gray-700">Type</span>
    <select [ngModel]="filterRequestType()" (ngModelChange)="filterRequestType.set($event)" class="min-w-[140px] rounded border border-gray-300 px-3 py-2 text-sm">
      <option value="">All</option>
      @for (rt of requestTypes(); track rt.id) {
        <option [value]="rt.id">{{ rt.name }}</option>
      }
    </select>
  </label>
  <label class="flex flex-col gap-1">
    <span class="text-sm font-medium text-gray-700">Priority</span>
    <select [ngModel]="filterPriority()" (ngModelChange)="filterPriority.set($event)" class="min-w-[140px] rounded border border-gray-300 px-3 py-2 text-sm">
      <option value="">All</option>
      @for (p of priorities; track p) {
        <option [value]="p">{{ p }}</option>
      }
    </select>
  </label>
  <label class="flex flex-col gap-1">
    <span class="text-sm font-medium text-gray-700">Assigned to</span>
    <select [ngModel]="filterAssignedTo()" (ngModelChange)="filterAssignedTo.set($event)" class="min-w-[140px] rounded border border-gray-300 px-3 py-2 text-sm">
      <option value="">All</option>
      @for (u of users(); track u.id) {
        <option [value]="u.id">{{ u.name }} ({{ u.identifier }})</option>
      }
    </select>
  </label>
  <button type="button" (click)="applyFilters()" class="px-4 py-2 rounded bg-primary text-white font-medium hover:bg-primary-dark">Apply</button>
  <button type="button" (click)="clearFilters()" class="px-4 py-2 rounded border border-gray-300 bg-white font-medium hover:bg-gray-50">Clear</button>
</div>

@if (loading()) {
  <p class="text-gray-600">Loading…</p>
} @else {
  <div class="rounded-lg border border-gray-200 bg-white shadow-sm overflow-hidden">
    <table class="w-full border-collapse">
      <thead>
        <tr class="bg-gray-50">
          <th class="px-3 py-2 text-left text-sm font-medium text-gray-700 border-b border-gray-200">Id</th>
          <th class="px-3 py-2 text-left text-sm font-medium text-gray-700 border-b border-gray-200">Type</th>
          <th class="px-3 py-2 text-left text-sm font-medium text-gray-700 border-b border-gray-200">State</th>
          <th class="px-3 py-2 text-left text-sm font-medium text-gray-700 border-b border-gray-200">Priority</th>
          <th class="px-3 py-2 text-left text-sm font-medium text-gray-700 border-b border-gray-200">Assigned to</th>
          <th class="px-3 py-2 text-left text-sm font-medium text-gray-700 border-b border-gray-200">Registered</th>
          <th class="px-3 py-2 text-left text-sm font-medium text-gray-700 border-b border-gray-200"></th>
        </tr>
      </thead>
      <tbody>
        @for (r of requests(); track r.id) {
          <tr class="border-b border-gray-100 hover:bg-gray-50">
            <td class="px-3 py-2 text-sm text-gray-900">{{ r.id }}</td>
            <td class="px-3 py-2 text-sm text-gray-900">{{ r.requestTypeName ?? r.requestTypeCode ?? r.requestTypeId }}</td>
            <td class="px-3 py-2 text-sm text-gray-900">{{ r.stateName ?? r.stateCode ?? r.stateId }}</td>
            <td class="px-3 py-2 text-sm text-gray-900">{{ r.priority ?? '—' }}</td>
            <td class="px-3 py-2 text-sm text-gray-900">{{ r.assignedToName ?? r.assignedToIdentifier ?? '—' }}</td>
            <td class="px-3 py-2 text-sm text-gray-600">{{ r.registeredAt | date:'short' }}</td>
            <td class="px-3 py-2"><a [routerLink]="['/requests', r.id]" class="text-primary font-medium hover:underline">View</a></td>
          </tr>
        }
      </tbody>
    </table>
  </div>
  @if (requests().length === 0) {
    <p class="mt-4 text-gray-600">No requests found.</p>
  }
}
